var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
  mod
));

// src/manager.tsx
var import_addons = require("@storybook/addons");

// src/constants.ts
var ADDON_ID = "storybook/interactions";
var PANEL_ID = `${ADDON_ID}/panel`;

// src/Panel.tsx
var import_global = __toESM(require("global"));
var React8 = __toESM(require("react"));
var import_api = require("@storybook/api");
var import_core_events = require("@storybook/core-events");
var import_instrumenter6 = require("@storybook/instrumenter");

// src/components/InteractionsPanel.tsx
var React7 = __toESM(require("react"));
var import_components4 = require("@storybook/components");
var import_instrumenter5 = require("@storybook/instrumenter");
var import_theming7 = require("@storybook/theming");
var import_polished3 = require("polished");

// src/components/Subnav.tsx
var import_react2 = __toESM(require("react"));
var import_components = require("@storybook/components");
var import_instrumenter2 = require("@storybook/instrumenter");
var import_theming2 = require("@storybook/theming");

// src/components/StatusBadge.tsx
var import_react = __toESM(require("react"));
var import_instrumenter = require("@storybook/instrumenter");
var import_theming = require("@storybook/theming");
var StyledBadge = import_theming.styled.div(({ theme: theme2, status }) => {
  const backgroundColor = {
    [import_instrumenter.CallStates.DONE]: theme2.color.positive,
    [import_instrumenter.CallStates.ERROR]: theme2.color.negative,
    [import_instrumenter.CallStates.ACTIVE]: theme2.color.warning,
    [import_instrumenter.CallStates.WAITING]: theme2.color.warning
  }[status];
  return {
    padding: "4px 6px 4px 8px;",
    borderRadius: "4px",
    backgroundColor,
    color: "white",
    fontFamily: import_theming.typography.fonts.base,
    textTransform: "uppercase",
    fontSize: import_theming.typography.size.s1,
    letterSpacing: 3,
    fontWeight: import_theming.typography.weight.bold,
    width: 65,
    textAlign: "center"
  };
});
var StatusBadge = ({ status }) => {
  const badgeText = {
    [import_instrumenter.CallStates.DONE]: "Pass",
    [import_instrumenter.CallStates.ERROR]: "Fail",
    [import_instrumenter.CallStates.ACTIVE]: "Runs",
    [import_instrumenter.CallStates.WAITING]: "Runs"
  }[status];
  return /* @__PURE__ */ import_react.default.createElement(StyledBadge, {
    status
  }, badgeText);
};

// src/components/Subnav.tsx
var SubnavWrapper = import_theming2.styled.div(({ theme: theme2 }) => ({
  background: theme2.background.app,
  borderBottom: `1px solid ${theme2.appBorderColor}`,
  position: "sticky",
  top: 0,
  zIndex: 1
}));
var StyledSubnav = import_theming2.styled.nav(({ theme: theme2 }) => ({
  height: 40,
  display: "flex",
  alignItems: "center",
  justifyContent: "space-between",
  paddingLeft: 15
}));
var StyledButton = (0, import_theming2.styled)(import_components.Button)(({ theme: theme2 }) => ({
  borderRadius: 4,
  padding: 6,
  color: theme2.textMutedColor,
  "&:not(:disabled)": {
    "&:hover,&:focus-visible": {
      color: theme2.color.secondary
    }
  }
}));
var Note = (0, import_theming2.styled)(import_components.TooltipNote)(({ theme: theme2 }) => ({
  fontFamily: theme2.typography.fonts.base
}));
var StyledIconButton = (0, import_theming2.styled)(import_components.IconButton)(({ theme: theme2 }) => ({
  color: theme2.color.mediumdark,
  margin: "0 3px"
}));
var StyledSeparator = (0, import_theming2.styled)(import_components.Separator)({
  marginTop: 0
});
var StyledLocation = (0, import_theming2.styled)(import_components.P)(({ theme: theme2 }) => ({
  color: theme2.textMutedColor,
  justifyContent: "flex-end",
  textAlign: "right",
  whiteSpace: "nowrap",
  marginTop: "auto",
  marginBottom: 1,
  paddingRight: 15,
  fontSize: 13
}));
var Group = import_theming2.styled.div({
  display: "flex",
  alignItems: "center"
});
var RewindButton = (0, import_theming2.styled)(StyledIconButton)({
  marginLeft: 9
});
var JumpToEndButton = (0, import_theming2.styled)(StyledButton)({
  marginLeft: 9,
  marginRight: 9,
  marginBottom: 1,
  lineHeight: "12px"
});
var RerunButton = (0, import_theming2.styled)(StyledIconButton)(({ theme: theme2, animating, disabled }) => ({
  opacity: disabled ? 0.5 : 1,
  svg: {
    animation: animating && `${theme2.animation.rotate360} 200ms ease-out`
  }
}));
var Subnav = ({
  controls,
  controlStates,
  status,
  storyFileName,
  onScrollToEnd,
  isRerunAnimating,
  setIsRerunAnimating
}) => {
  const buttonText = status === import_instrumenter2.CallStates.ERROR ? "Scroll to error" : "Scroll to end";
  return /* @__PURE__ */ import_react2.default.createElement(SubnavWrapper, null, /* @__PURE__ */ import_react2.default.createElement(import_components.Bar, null, /* @__PURE__ */ import_react2.default.createElement(StyledSubnav, null, /* @__PURE__ */ import_react2.default.createElement(Group, null, /* @__PURE__ */ import_react2.default.createElement(StatusBadge, {
    status
  }), /* @__PURE__ */ import_react2.default.createElement(JumpToEndButton, {
    onClick: onScrollToEnd,
    disabled: !onScrollToEnd
  }, buttonText), /* @__PURE__ */ import_react2.default.createElement(StyledSeparator, null), /* @__PURE__ */ import_react2.default.createElement(import_components.WithTooltip, {
    hasChrome: false,
    tooltip: /* @__PURE__ */ import_react2.default.createElement(Note, {
      note: "Go to start"
    })
  }, /* @__PURE__ */ import_react2.default.createElement(RewindButton, {
    "aria-label": "Go to start",
    containsIcon: true,
    onClick: controls.start,
    disabled: !controlStates.start
  }, /* @__PURE__ */ import_react2.default.createElement(import_components.Icons, {
    icon: "rewind"
  }))), /* @__PURE__ */ import_react2.default.createElement(import_components.WithTooltip, {
    hasChrome: false,
    tooltip: /* @__PURE__ */ import_react2.default.createElement(Note, {
      note: "Go back"
    })
  }, /* @__PURE__ */ import_react2.default.createElement(StyledIconButton, {
    "aria-label": "Go back",
    containsIcon: true,
    onClick: controls.back,
    disabled: !controlStates.back
  }, /* @__PURE__ */ import_react2.default.createElement(import_components.Icons, {
    icon: "playback"
  }))), /* @__PURE__ */ import_react2.default.createElement(import_components.WithTooltip, {
    hasChrome: false,
    tooltip: /* @__PURE__ */ import_react2.default.createElement(Note, {
      note: "Go forward"
    })
  }, /* @__PURE__ */ import_react2.default.createElement(StyledIconButton, {
    "aria-label": "Go forward",
    containsIcon: true,
    onClick: controls.next,
    disabled: !controlStates.next
  }, /* @__PURE__ */ import_react2.default.createElement(import_components.Icons, {
    icon: "playnext"
  }))), /* @__PURE__ */ import_react2.default.createElement(import_components.WithTooltip, {
    hasChrome: false,
    tooltip: /* @__PURE__ */ import_react2.default.createElement(Note, {
      note: "Go to end"
    })
  }, /* @__PURE__ */ import_react2.default.createElement(StyledIconButton, {
    "aria-label": "Go to end",
    containsIcon: true,
    onClick: controls.end,
    disabled: !controlStates.end
  }, /* @__PURE__ */ import_react2.default.createElement(import_components.Icons, {
    icon: "fastforward"
  }))), /* @__PURE__ */ import_react2.default.createElement(import_components.WithTooltip, {
    hasChrome: false,
    tooltip: /* @__PURE__ */ import_react2.default.createElement(Note, {
      note: "Rerun"
    })
  }, /* @__PURE__ */ import_react2.default.createElement(RerunButton, {
    "aria-label": "Rerun",
    containsIcon: true,
    onClick: controls.rerun,
    onAnimationEnd: () => setIsRerunAnimating(false),
    animating: isRerunAnimating,
    disabled: isRerunAnimating
  }, /* @__PURE__ */ import_react2.default.createElement(import_components.Icons, {
    icon: "sync"
  })))), storyFileName && /* @__PURE__ */ import_react2.default.createElement(Group, null, /* @__PURE__ */ import_react2.default.createElement(StyledLocation, null, storyFileName)))));
};

// src/components/Interaction.tsx
var React6 = __toESM(require("react"));
var import_components3 = require("@storybook/components");
var import_instrumenter4 = require("@storybook/instrumenter");
var import_theming6 = require("@storybook/theming");
var import_polished2 = require("polished");

// src/components/MatcherResult.tsx
var import_react4 = __toESM(require("react"));
var import_theming4 = require("@storybook/theming");

// src/components/MethodCall.tsx
var import_object_inspector = require("@devtools-ds/object-inspector");
var import_theming3 = require("@storybook/theming");
var import_react3 = __toESM(require("react"));
var colorsLight = {
  base: "#444",
  nullish: "#7D99AA",
  string: "#16B242",
  number: "#5D40D0",
  boolean: "#f41840",
  objectkey: "#698394",
  instance: "#A15C20",
  function: "#EA7509",
  muted: "#7D99AA",
  tag: {
    name: "#6F2CAC",
    suffix: "#1F99E5"
  },
  date: "#459D9C",
  error: {
    name: "#D43900",
    message: "#444"
  },
  regex: {
    source: "#A15C20",
    flags: "#EA7509"
  },
  meta: "#EA7509",
  method: "#0271B6"
};
var colorsDark = {
  base: "#eee",
  nullish: "#aaa",
  string: "#5FE584",
  number: "#6ba5ff",
  boolean: "#ff4191",
  objectkey: "#accfe6",
  instance: "#E3B551",
  function: "#E3B551",
  muted: "#aaa",
  tag: {
    name: "#f57bff",
    suffix: "#8EB5FF"
  },
  date: "#70D4D3",
  error: {
    name: "#f40",
    message: "#eee"
  },
  regex: {
    source: "#FAD483",
    flags: "#E3B551"
  },
  meta: "#FAD483",
  method: "#5EC1FF"
};
var useThemeColors = () => {
  const { base } = (0, import_theming3.useTheme)();
  return base === "dark" ? colorsDark : colorsLight;
};
var special = /[^A-Z0-9]/i;
var trimEnd = /[\s.,â€¦]+$/gm;
var ellipsize = (string, maxlength) => {
  if (string.length <= maxlength)
    return string;
  for (let i = maxlength - 1; i >= 0; i -= 1) {
    if (special.test(string[i]) && i > 10) {
      return `${string.slice(0, i).replace(trimEnd, "")}\u2026`;
    }
  }
  return `${string.slice(0, maxlength).replace(trimEnd, "")}\u2026`;
};
var stringify = (value) => {
  try {
    return JSON.stringify(value, null, 1);
  } catch (e) {
    return String(value);
  }
};
var interleave = (nodes, separator) => nodes.flatMap(
  (node, index) => index === nodes.length - 1 ? [node] : [node, import_react3.default.cloneElement(separator, { key: `sep${index}` })]
);
var Node = ({
  value,
  nested,
  showObjectInspector,
  callsById,
  ...props
}) => {
  switch (true) {
    case value === null:
      return /* @__PURE__ */ import_react3.default.createElement(NullNode, {
        ...props
      });
    case value === void 0:
      return /* @__PURE__ */ import_react3.default.createElement(UndefinedNode, {
        ...props
      });
    case Array.isArray(value):
      return /* @__PURE__ */ import_react3.default.createElement(ArrayNode, {
        ...props,
        value,
        callsById
      });
    case typeof value === "string":
      return /* @__PURE__ */ import_react3.default.createElement(StringNode, {
        ...props,
        value
      });
    case typeof value === "number":
      return /* @__PURE__ */ import_react3.default.createElement(NumberNode, {
        ...props,
        value
      });
    case typeof value === "boolean":
      return /* @__PURE__ */ import_react3.default.createElement(BooleanNode, {
        ...props,
        value
      });
    case Object.prototype.hasOwnProperty.call(value, "__date__"):
      return /* @__PURE__ */ import_react3.default.createElement(DateNode, {
        ...props,
        ...value.__date__
      });
    case Object.prototype.hasOwnProperty.call(value, "__error__"):
      return /* @__PURE__ */ import_react3.default.createElement(ErrorNode, {
        ...props,
        ...value.__error__
      });
    case Object.prototype.hasOwnProperty.call(value, "__regexp__"):
      return /* @__PURE__ */ import_react3.default.createElement(RegExpNode, {
        ...props,
        ...value.__regexp__
      });
    case Object.prototype.hasOwnProperty.call(value, "__function__"):
      return /* @__PURE__ */ import_react3.default.createElement(FunctionNode, {
        ...props,
        ...value.__function__
      });
    case Object.prototype.hasOwnProperty.call(value, "__symbol__"):
      return /* @__PURE__ */ import_react3.default.createElement(SymbolNode, {
        ...props,
        ...value.__symbol__
      });
    case Object.prototype.hasOwnProperty.call(value, "__element__"):
      return /* @__PURE__ */ import_react3.default.createElement(ElementNode, {
        ...props,
        ...value.__element__
      });
    case Object.prototype.hasOwnProperty.call(value, "__class__"):
      return /* @__PURE__ */ import_react3.default.createElement(ClassNode, {
        ...props,
        ...value.__class__
      });
    case Object.prototype.hasOwnProperty.call(value, "__callId__"):
      return /* @__PURE__ */ import_react3.default.createElement(MethodCall, {
        call: callsById.get(value.__callId__),
        callsById
      });
    case Object.prototype.toString.call(value) === "[object Object]":
      return /* @__PURE__ */ import_react3.default.createElement(ObjectNode, {
        value,
        showInspector: showObjectInspector,
        ...props
      });
    default:
      return /* @__PURE__ */ import_react3.default.createElement(OtherNode, {
        value,
        ...props
      });
  }
};
var NullNode = (props) => {
  const colors2 = useThemeColors();
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.nullish },
    ...props
  }, "null");
};
var UndefinedNode = (props) => {
  const colors2 = useThemeColors();
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.nullish },
    ...props
  }, "undefined");
};
var StringNode = ({ value, ...props }) => {
  const colors2 = useThemeColors();
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.string },
    ...props
  }, JSON.stringify(ellipsize(value, 50)));
};
var NumberNode = ({ value, ...props }) => {
  const colors2 = useThemeColors();
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.number },
    ...props
  }, value);
};
var BooleanNode = ({ value, ...props }) => {
  const colors2 = useThemeColors();
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.boolean },
    ...props
  }, String(value));
};
var ArrayNode = ({
  value,
  nested = false,
  callsById
}) => {
  const colors2 = useThemeColors();
  if (nested) {
    return /* @__PURE__ */ import_react3.default.createElement("span", {
      style: { color: colors2.base }
    }, "[\u2026]");
  }
  const nodes = value.slice(0, 3).map((v) => /* @__PURE__ */ import_react3.default.createElement(Node, {
    key: JSON.stringify(v),
    value: v,
    nested: true,
    callsById
  }));
  const nodelist = interleave(nodes, /* @__PURE__ */ import_react3.default.createElement("span", null, ", "));
  if (value.length <= 3) {
    return /* @__PURE__ */ import_react3.default.createElement("span", {
      style: { color: colors2.base }
    }, "[", nodelist, "]");
  }
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.base }
  }, "(", value.length, ") [", nodelist, ", \u2026]");
};
var ObjectNode = ({
  showInspector,
  value,
  nested = false
}) => {
  const isDarkMode = (0, import_theming3.useTheme)().base === "dark";
  const colors2 = useThemeColors();
  if (showInspector) {
    return /* @__PURE__ */ import_react3.default.createElement(import_react3.default.Fragment, null, /* @__PURE__ */ import_react3.default.createElement(import_object_inspector.ObjectInspector, {
      id: "interactions-object-inspector",
      data: value,
      includePrototypes: false,
      colorScheme: isDarkMode ? "dark" : "light"
    }));
  }
  if (nested) {
    return /* @__PURE__ */ import_react3.default.createElement("span", {
      style: { color: colors2.base }
    }, "{\u2026}");
  }
  const nodelist = interleave(
    Object.entries(value).slice(0, 2).map(([k, v]) => /* @__PURE__ */ import_react3.default.createElement(import_react3.Fragment, {
      key: k
    }, /* @__PURE__ */ import_react3.default.createElement("span", {
      style: { color: colors2.objectkey }
    }, k, ": "), /* @__PURE__ */ import_react3.default.createElement(Node, {
      value: v,
      nested: true
    }))),
    /* @__PURE__ */ import_react3.default.createElement("span", null, ", ")
  );
  if (Object.keys(value).length <= 2) {
    return /* @__PURE__ */ import_react3.default.createElement("span", {
      style: { color: colors2.base }
    }, "{ ", nodelist, " }");
  }
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.base }
  }, "(", Object.keys(value).length, ") ", "{ ", nodelist, ", \u2026 }");
};
var ClassNode = ({ name }) => {
  const colors2 = useThemeColors();
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.instance }
  }, name);
};
var FunctionNode = ({ name }) => {
  const colors2 = useThemeColors();
  return name ? /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.function }
  }, name) : /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.nullish, fontStyle: "italic" }
  }, "anonymous");
};
var ElementNode = ({
  prefix,
  localName,
  id,
  classNames = [],
  innerText
}) => {
  const name = prefix ? `${prefix}:${localName}` : localName;
  const colors2 = useThemeColors();
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { wordBreak: "keep-all" }
  }, /* @__PURE__ */ import_react3.default.createElement("span", {
    key: `${name}_lt`,
    style: { color: colors2.muted }
  }, "<"), /* @__PURE__ */ import_react3.default.createElement("span", {
    key: `${name}_tag`,
    style: { color: colors2.tag.name }
  }, name), /* @__PURE__ */ import_react3.default.createElement("span", {
    key: `${name}_suffix`,
    style: { color: colors2.tag.suffix }
  }, id ? `#${id}` : classNames.reduce((acc, className) => `${acc}.${className}`, "")), /* @__PURE__ */ import_react3.default.createElement("span", {
    key: `${name}_gt`,
    style: { color: colors2.muted }
  }, ">"), !id && classNames.length === 0 && innerText && /* @__PURE__ */ import_react3.default.createElement(import_react3.default.Fragment, null, /* @__PURE__ */ import_react3.default.createElement("span", {
    key: `${name}_text`
  }, innerText), /* @__PURE__ */ import_react3.default.createElement("span", {
    key: `${name}_close_lt`,
    style: { color: colors2.muted }
  }, "<"), /* @__PURE__ */ import_react3.default.createElement("span", {
    key: `${name}_close_tag`,
    style: { color: colors2.tag.name }
  }, "/", name), /* @__PURE__ */ import_react3.default.createElement("span", {
    key: `${name}_close_gt`,
    style: { color: colors2.muted }
  }, ">")));
};
var DateNode = ({ value }) => {
  const [date, time, ms] = value.split(/[T.Z]/);
  const colors2 = useThemeColors();
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { whiteSpace: "nowrap", color: colors2.date }
  }, date, /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { opacity: 0.7 }
  }, "T"), time === "00:00:00" ? /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { opacity: 0.7 }
  }, time) : time, ms === "000" ? /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { opacity: 0.7 }
  }, ".", ms) : `.${ms}`, /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { opacity: 0.7 }
  }, "Z"));
};
var ErrorNode = ({ name, message }) => {
  const colors2 = useThemeColors();
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.error.name }
  }, name, message && ": ", message && /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.error.message },
    title: message.length > 50 ? message : ""
  }, ellipsize(message, 50)));
};
var RegExpNode = ({ flags, source }) => {
  const colors2 = useThemeColors();
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { whiteSpace: "nowrap", color: colors2.regex.flags }
  }, "/", /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.regex.source }
  }, source), "/", flags);
};
var SymbolNode = ({ description }) => {
  const colors2 = useThemeColors();
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { whiteSpace: "nowrap", color: colors2.instance }
  }, "Symbol(", description && /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.meta }
  }, '"', description, '"'), ")");
};
var OtherNode = ({ value }) => {
  const colors2 = useThemeColors();
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.meta }
  }, stringify(value));
};
var StepNode = ({ label }) => {
  const colors2 = useThemeColors();
  const { typography: typography4 } = (0, import_theming3.useTheme)();
  return /* @__PURE__ */ import_react3.default.createElement("span", {
    style: {
      color: colors2.base,
      fontFamily: typography4.fonts.base,
      fontSize: typography4.size.s2 - 1
    }
  }, label);
};
var MethodCall = ({
  call,
  callsById
}) => {
  if (!call)
    return null;
  if (call.method === "step" && call.path.length === 0) {
    return /* @__PURE__ */ import_react3.default.createElement(StepNode, {
      label: call.args[0]
    });
  }
  const path = call.path.flatMap((elem, index) => {
    const callId = elem.__callId__;
    return [
      callId ? /* @__PURE__ */ import_react3.default.createElement(MethodCall, {
        key: `elem${index}`,
        call: callsById.get(callId),
        callsById
      }) : /* @__PURE__ */ import_react3.default.createElement("span", {
        key: `elem${index}`
      }, elem),
      /* @__PURE__ */ import_react3.default.createElement("wbr", {
        key: `wbr${index}`
      }),
      /* @__PURE__ */ import_react3.default.createElement("span", {
        key: `dot${index}`
      }, ".")
    ];
  });
  const args = call.args.flatMap((arg, index, array) => {
    const node = /* @__PURE__ */ import_react3.default.createElement(Node, {
      key: `node${index}`,
      value: arg,
      callsById
    });
    return index < array.length - 1 ? [node, /* @__PURE__ */ import_react3.default.createElement("span", {
      key: `comma${index}`
    }, ",\xA0"), /* @__PURE__ */ import_react3.default.createElement("wbr", {
      key: `wbr${index}`
    })] : [node];
  });
  const colors2 = useThemeColors();
  return /* @__PURE__ */ import_react3.default.createElement(import_react3.default.Fragment, null, /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.base }
  }, path), /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.method }
  }, call.method), /* @__PURE__ */ import_react3.default.createElement("span", {
    style: { color: colors2.base }
  }, "(", /* @__PURE__ */ import_react3.default.createElement("wbr", null), args, /* @__PURE__ */ import_react3.default.createElement("wbr", null), ")"));
};

// src/components/MatcherResult.tsx
var getParams = (line, fromIndex = 0) => {
  for (let i = fromIndex, depth = 1; i < line.length; i += 1) {
    if (line[i] === "(")
      depth += 1;
    else if (line[i] === ")")
      depth -= 1;
    if (depth === 0)
      return line.slice(fromIndex, i);
  }
  return "";
};
var parseValue = (value) => {
  try {
    return value === "undefined" ? void 0 : JSON.parse(value);
  } catch (e) {
    return value;
  }
};
var StyledExpected = import_theming4.styled.span(({ theme: theme2 }) => ({
  color: theme2.color.positive
}));
var StyledReceived = import_theming4.styled.span(({ theme: theme2 }) => ({
  color: theme2.color.negative
}));
var Received = ({ value, parsed }) => parsed ? /* @__PURE__ */ import_react4.default.createElement(Node, {
  showObjectInspector: true,
  value,
  style: { color: "#D43900" }
}) : /* @__PURE__ */ import_react4.default.createElement(StyledReceived, null, value);
var Expected = ({ value, parsed }) => {
  if (parsed) {
    if (typeof value === "string" && value.startsWith("called with")) {
      return /* @__PURE__ */ import_react4.default.createElement(import_react4.default.Fragment, null, value);
    }
    return /* @__PURE__ */ import_react4.default.createElement(Node, {
      showObjectInspector: true,
      value,
      style: { color: "#16B242" }
    });
  }
  return /* @__PURE__ */ import_react4.default.createElement(StyledExpected, null, value);
};
var MatcherResult = ({ message }) => {
  const lines = message.split("\n");
  return /* @__PURE__ */ import_react4.default.createElement("pre", {
    style: {
      margin: 0,
      padding: "8px 10px 8px 36px",
      fontSize: import_theming4.typography.size.s1
    }
  }, lines.flatMap((line, index) => {
    if (line.startsWith("expect(")) {
      const received = getParams(line, 7);
      const remainderIndex = received && 7 + received.length;
      const matcher = received && line.slice(remainderIndex).match(/\.(to|last|nth)[A-Z]\w+\(/);
      if (matcher) {
        const expectedIndex = remainderIndex + matcher.index + matcher[0].length;
        const expected = getParams(line, expectedIndex);
        if (expected) {
          return [
            "expect(",
            /* @__PURE__ */ import_react4.default.createElement(Received, {
              key: `received_${received}`,
              value: received
            }),
            line.slice(remainderIndex, expectedIndex),
            /* @__PURE__ */ import_react4.default.createElement(Expected, {
              key: `expected_${expected}`,
              value: expected
            }),
            line.slice(expectedIndex + expected.length),
            /* @__PURE__ */ import_react4.default.createElement("br", {
              key: `br${index}`
            })
          ];
        }
      }
    }
    if (line.match(/^\s*- /)) {
      return [/* @__PURE__ */ import_react4.default.createElement(Expected, {
        key: line + index,
        value: line
      }), /* @__PURE__ */ import_react4.default.createElement("br", {
        key: `br${index}`
      })];
    }
    if (line.match(/^\s*\+ /)) {
      return [/* @__PURE__ */ import_react4.default.createElement(Received, {
        key: line + index,
        value: line
      }), /* @__PURE__ */ import_react4.default.createElement("br", {
        key: `br${index}`
      })];
    }
    const [, assertionLabel, assertionValue] = line.match(/^(Expected|Received): (.*)$/) || [];
    if (assertionLabel && assertionValue) {
      return assertionLabel === "Expected" ? [
        "Expected: ",
        /* @__PURE__ */ import_react4.default.createElement(Expected, {
          key: line + index,
          value: parseValue(assertionValue),
          parsed: true
        }),
        /* @__PURE__ */ import_react4.default.createElement("br", {
          key: `br${index}`
        })
      ] : [
        "Received: ",
        /* @__PURE__ */ import_react4.default.createElement(Received, {
          key: line + index,
          value: parseValue(assertionValue),
          parsed: true
        }),
        /* @__PURE__ */ import_react4.default.createElement("br", {
          key: `br${index}`
        })
      ];
    }
    const [, prefix, numberOfCalls] = line.match(/(Expected number|Received number|Number) of calls: (\d+)$/i) || [];
    if (prefix && numberOfCalls) {
      return [
        `${prefix} of calls: `,
        /* @__PURE__ */ import_react4.default.createElement(Node, {
          key: line + index,
          value: Number(numberOfCalls)
        }),
        /* @__PURE__ */ import_react4.default.createElement("br", {
          key: `br${index}`
        })
      ];
    }
    const [, receivedValue] = line.match(/^Received has value: (.+)$/) || [];
    if (receivedValue) {
      return [
        "Received has value: ",
        /* @__PURE__ */ import_react4.default.createElement(Node, {
          key: line + index,
          value: parseValue(receivedValue)
        }),
        /* @__PURE__ */ import_react4.default.createElement("br", {
          key: `br${index}`
        })
      ];
    }
    return [/* @__PURE__ */ import_react4.default.createElement("span", {
      key: line + index
    }, line), /* @__PURE__ */ import_react4.default.createElement("br", {
      key: `br${index}`
    })];
  }));
};

// src/components/StatusIcon.tsx
var import_react5 = __toESM(require("react"));
var import_components2 = require("@storybook/components");
var import_instrumenter3 = require("@storybook/instrumenter");
var import_theming5 = require("@storybook/theming");
var import_polished = require("polished");

// src/theme.ts
var colors = {
  pure: {
    gray: {
      500: "#CCCCCC"
    }
  }
};
var theme = {
  colors
};
var theme_default = theme;

// src/components/StatusIcon.tsx
var {
  colors: {
    pure: { gray }
  }
} = theme_default;
var StyledStatusIcon = (0, import_theming5.styled)(import_components2.Icons)(({ theme: theme2, status }) => {
  const color = {
    [import_instrumenter3.CallStates.DONE]: theme2.color.positive,
    [import_instrumenter3.CallStates.ERROR]: theme2.color.negative,
    [import_instrumenter3.CallStates.ACTIVE]: theme2.color.secondary,
    [import_instrumenter3.CallStates.WAITING]: (0, import_polished.transparentize)(0.5, gray[500])
  }[status];
  return {
    width: status === import_instrumenter3.CallStates.WAITING ? 6 : 12,
    height: status === import_instrumenter3.CallStates.WAITING ? 6 : 12,
    color,
    justifySelf: "center"
  };
});
var StatusIcon = ({ status, className }) => {
  const icon = {
    [import_instrumenter3.CallStates.DONE]: "check",
    [import_instrumenter3.CallStates.ERROR]: "stopalt",
    [import_instrumenter3.CallStates.ACTIVE]: "play",
    [import_instrumenter3.CallStates.WAITING]: "circle"
  }[status];
  return /* @__PURE__ */ import_react5.default.createElement(StyledStatusIcon, {
    "data-testid": `icon-${status}`,
    status,
    icon,
    className
  });
};

// src/components/Interaction.tsx
var MethodCallWrapper = import_theming6.styled.div(() => ({
  fontFamily: import_theming6.typography.fonts.mono,
  fontSize: import_theming6.typography.size.s1,
  overflowWrap: "break-word",
  inlineSize: "calc( 100% - 40px )"
}));
var RowContainer = (0, import_theming6.styled)("div", {
  shouldForwardProp: (prop) => !["call", "pausedAt"].includes(prop.toString())
})(
  ({ theme: theme2, call }) => ({
    position: "relative",
    display: "flex",
    flexDirection: "column",
    borderBottom: `1px solid ${theme2.appBorderColor}`,
    fontFamily: import_theming6.typography.fonts.base,
    fontSize: 13,
    ...call.status === import_instrumenter4.CallStates.ERROR && {
      backgroundColor: theme2.base === "dark" ? (0, import_polished2.transparentize)(0.93, theme2.color.negative) : theme2.background.warning
    },
    paddingLeft: call.ancestors.length * 20
  }),
  ({ theme: theme2, call, pausedAt }) => pausedAt === call.id && {
    "&::before": {
      content: '""',
      position: "absolute",
      top: -5,
      zIndex: 1,
      borderTop: "4.5px solid transparent",
      borderLeft: `7px solid ${theme2.color.warning}`,
      borderBottom: "4.5px solid transparent"
    },
    "&::after": {
      content: '""',
      position: "absolute",
      top: -1,
      zIndex: 1,
      width: "100%",
      borderTop: `1.5px solid ${theme2.color.warning}`
    }
  }
);
var RowHeader = import_theming6.styled.div(({ theme: theme2, isInteractive }) => ({
  display: "flex",
  "&:hover": isInteractive ? {} : { background: theme2.background.hoverable }
}));
var RowLabel = (0, import_theming6.styled)("button", {
  shouldForwardProp: (prop) => !["call"].includes(prop.toString())
})(({ theme: theme2, disabled, call }) => ({
  flex: 1,
  display: "grid",
  background: "none",
  border: 0,
  gridTemplateColumns: "15px 1fr",
  alignItems: "center",
  minHeight: 40,
  margin: 0,
  padding: "8px 15px",
  textAlign: "start",
  cursor: disabled || call.status === import_instrumenter4.CallStates.ERROR ? "default" : "pointer",
  "&:focus-visible": {
    outline: 0,
    boxShadow: `inset 3px 0 0 0 ${call.status === import_instrumenter4.CallStates.ERROR ? theme2.color.warning : theme2.color.secondary}`,
    background: call.status === import_instrumenter4.CallStates.ERROR ? "transparent" : theme2.background.hoverable
  },
  "& > div": {
    opacity: call.status === import_instrumenter4.CallStates.WAITING ? 0.5 : 1
  }
}));
var RowActions = import_theming6.styled.div({
  padding: 6
});
var StyledIconButton2 = (0, import_theming6.styled)(import_components3.IconButton)(({ theme: theme2 }) => ({
  color: theme2.color.mediumdark,
  margin: "0 3px"
}));
var Note2 = (0, import_theming6.styled)(import_components3.TooltipNote)(({ theme: theme2 }) => ({
  fontFamily: theme2.typography.fonts.base
}));
var RowMessage = (0, import_theming6.styled)("div")(({ theme: theme2 }) => ({
  padding: "8px 10px 8px 36px",
  fontSize: import_theming6.typography.size.s1,
  color: theme2.color.defaultText,
  pre: {
    margin: 0,
    padding: 0
  }
}));
var Exception = ({ exception }) => {
  if (exception.message.startsWith("expect(")) {
    return /* @__PURE__ */ React6.createElement(MatcherResult, {
      ...exception
    });
  }
  const paragraphs = exception.message.split("\n\n");
  const more = paragraphs.length > 1;
  return /* @__PURE__ */ React6.createElement(RowMessage, null, /* @__PURE__ */ React6.createElement("pre", null, paragraphs[0]), more && /* @__PURE__ */ React6.createElement("p", null, "See the full stack trace in the browser console."));
};
var Interaction = ({
  call,
  callsById,
  controls,
  controlStates,
  childCallIds,
  isHidden,
  isCollapsed,
  toggleCollapsed,
  pausedAt
}) => {
  var _a;
  const [isHovered, setIsHovered] = React6.useState(false);
  const isInteractive = !controlStates.goto || !call.interceptable || !!call.ancestors.length;
  if (isHidden)
    return null;
  return /* @__PURE__ */ React6.createElement(RowContainer, {
    call,
    pausedAt
  }, /* @__PURE__ */ React6.createElement(RowHeader, {
    isInteractive
  }, /* @__PURE__ */ React6.createElement(RowLabel, {
    call,
    onClick: () => controls.goto(call.id),
    disabled: isInteractive,
    onMouseEnter: () => controlStates.goto && setIsHovered(true),
    onMouseLeave: () => controlStates.goto && setIsHovered(false)
  }, /* @__PURE__ */ React6.createElement(StatusIcon, {
    status: isHovered ? import_instrumenter4.CallStates.ACTIVE : call.status
  }), /* @__PURE__ */ React6.createElement(MethodCallWrapper, {
    style: { marginLeft: 6, marginBottom: 1 }
  }, /* @__PURE__ */ React6.createElement(MethodCall, {
    call,
    callsById
  }))), /* @__PURE__ */ React6.createElement(RowActions, null, (childCallIds == null ? void 0 : childCallIds.length) > 0 && /* @__PURE__ */ React6.createElement(import_components3.WithTooltip, {
    hasChrome: false,
    tooltip: /* @__PURE__ */ React6.createElement(Note2, {
      note: `${isCollapsed ? "Show" : "Hide"} interactions`
    })
  }, /* @__PURE__ */ React6.createElement(StyledIconButton2, {
    containsIcon: true,
    onClick: toggleCollapsed
  }, /* @__PURE__ */ React6.createElement(import_components3.Icons, {
    icon: "listunordered"
  }))))), call.status === import_instrumenter4.CallStates.ERROR && ((_a = call.exception) == null ? void 0 : _a.callId) === call.id && /* @__PURE__ */ React6.createElement(Exception, {
    exception: call.exception
  }));
};

// src/components/InteractionsPanel.tsx
var Container = import_theming7.styled.div(({ theme: theme2, withException }) => ({
  minHeight: "100%",
  background: theme2.background.content,
  ...withException && {
    backgroundColor: theme2.base === "dark" ? (0, import_polished3.transparentize)(0.93, theme2.color.negative) : theme2.background.warning
  }
}));
var CaughtException = import_theming7.styled.div(({ theme: theme2 }) => ({
  padding: 15,
  fontSize: theme2.typography.size.s2 - 1,
  lineHeight: "19px"
}));
var CaughtExceptionCode = import_theming7.styled.code(({ theme: theme2 }) => ({
  margin: "0 1px",
  padding: 3,
  fontSize: theme2.typography.size.s1 - 1,
  lineHeight: 1,
  verticalAlign: "top",
  background: "rgba(0, 0, 0, 0.05)",
  border: `1px solid ${theme2.color.border}`,
  borderRadius: 3
}));
var CaughtExceptionTitle = import_theming7.styled.div({
  paddingBottom: 4,
  fontWeight: "bold"
});
var CaughtExceptionDescription = import_theming7.styled.p({
  margin: 0,
  padding: "0 0 20px"
});
var CaughtExceptionStack = import_theming7.styled.pre(({ theme: theme2 }) => ({
  margin: 0,
  padding: 0,
  fontSize: theme2.typography.size.s1 - 1
}));
var InteractionsPanel = React7.memo(
  ({
    calls,
    controls,
    controlStates,
    interactions,
    fileName,
    hasException,
    caughtException,
    isPlaying,
    pausedAt,
    onScrollToEnd,
    endRef,
    isRerunAnimating,
    setIsRerunAnimating,
    ...panelProps
  }) => {
    var _a;
    return /* @__PURE__ */ React7.createElement(import_components4.AddonPanel, {
      ...panelProps
    }, /* @__PURE__ */ React7.createElement(Container, {
      withException: !!caughtException
    }, controlStates.debugger && (interactions.length > 0 || hasException || isRerunAnimating) && /* @__PURE__ */ React7.createElement(Subnav, {
      controls,
      controlStates,
      status: isPlaying ? import_instrumenter5.CallStates.ACTIVE : hasException ? import_instrumenter5.CallStates.ERROR : import_instrumenter5.CallStates.DONE,
      storyFileName: fileName,
      onScrollToEnd,
      isRerunAnimating,
      setIsRerunAnimating
    }), /* @__PURE__ */ React7.createElement("div", null, interactions.map((call) => /* @__PURE__ */ React7.createElement(Interaction, {
      key: call.id,
      call,
      callsById: calls,
      controls,
      controlStates,
      childCallIds: call.childCallIds,
      isHidden: call.isHidden,
      isCollapsed: call.isCollapsed,
      toggleCollapsed: call.toggleCollapsed,
      pausedAt
    }))), caughtException && !((_a = caughtException.message) == null ? void 0 : _a.startsWith("ignoredException")) && /* @__PURE__ */ React7.createElement(CaughtException, null, /* @__PURE__ */ React7.createElement(CaughtExceptionTitle, null, "Caught exception in ", /* @__PURE__ */ React7.createElement(CaughtExceptionCode, null, "play"), " function"), /* @__PURE__ */ React7.createElement(CaughtExceptionDescription, null, "This story threw an error after it finished rendering which means your interactions couldn't be run. Go to this story's play function in ", fileName, " to fix."), /* @__PURE__ */ React7.createElement(CaughtExceptionStack, {
      "data-chromatic": "ignore"
    }, caughtException.stack || `${caughtException.name}: ${caughtException.message}`)), /* @__PURE__ */ React7.createElement("div", {
      ref: endRef
    }), !isPlaying && !caughtException && interactions.length === 0 && /* @__PURE__ */ React7.createElement(import_components4.Placeholder, null, "No interactions found", /* @__PURE__ */ React7.createElement(import_components4.Link, {
      href: "https://storybook.js.org/docs/react/writing-stories/play-function",
      target: "_blank",
      withArrow: true
    }, "Learn how to add interactions to your story"))));
  }
);

// src/components/TabStatus.tsx
var import_theming8 = require("@storybook/theming");
var import_react_dom = __toESM(require("react-dom"));
var TabStatus = ({ children }) => {
  const container = global.document.getElementById("tabbutton-interactions");
  return container && import_react_dom.default.createPortal(children, container);
};
var TabIcon = (0, import_theming8.styled)(StatusIcon)({
  marginLeft: 5
});

// src/Panel.tsx
var INITIAL_CONTROL_STATES = {
  debugger: false,
  start: false,
  back: false,
  goto: false,
  next: false,
  end: false
};
var getInteractions = ({
  log,
  calls,
  collapsed,
  setCollapsed
}) => {
  const callsById = /* @__PURE__ */ new Map();
  const childCallMap = /* @__PURE__ */ new Map();
  return log.map(({ callId, ancestors, status }) => {
    let isHidden = false;
    ancestors.forEach((ancestor) => {
      if (collapsed.has(ancestor))
        isHidden = true;
      childCallMap.set(ancestor, (childCallMap.get(ancestor) || []).concat(callId));
    });
    return { ...calls.get(callId), status, isHidden };
  }).map((call) => {
    var _a;
    const status = call.status === import_instrumenter6.CallStates.ERROR && ((_a = callsById.get(call.ancestors.slice(-1)[0])) == null ? void 0 : _a.status) === import_instrumenter6.CallStates.ACTIVE ? import_instrumenter6.CallStates.ACTIVE : call.status;
    callsById.set(call.id, { ...call, status });
    return {
      ...call,
      status,
      childCallIds: childCallMap.get(call.id),
      isCollapsed: collapsed.has(call.id),
      toggleCollapsed: () => setCollapsed((ids) => {
        if (ids.has(call.id))
          ids.delete(call.id);
        else
          ids.add(call.id);
        return new Set(ids);
      })
    };
  });
};
var Panel = (props) => {
  const [storyId, setStoryId] = React8.useState();
  const [controlStates, setControlStates] = React8.useState(INITIAL_CONTROL_STATES);
  const [pausedAt, setPausedAt] = React8.useState();
  const [isErrored, setErrored] = React8.useState(false);
  const [isPlaying, setPlaying] = React8.useState(false);
  const [isRerunAnimating, setIsRerunAnimating] = React8.useState(false);
  const [scrollTarget, setScrollTarget] = React8.useState();
  const [collapsed, setCollapsed] = React8.useState(/* @__PURE__ */ new Set());
  const [caughtException, setCaughtException] = React8.useState();
  const [interactions, setInteractions] = React8.useState([]);
  const [interactionsCount, setInteractionsCount] = React8.useState();
  const log = React8.useRef([]);
  const calls = React8.useRef(/* @__PURE__ */ new Map());
  const setCall = ({ status, ...call }) => calls.current.set(call.id, call);
  const endRef = React8.useRef();
  React8.useEffect(() => {
    let observer;
    if (import_global.default.window.IntersectionObserver) {
      observer = new import_global.default.window.IntersectionObserver(
        ([end]) => setScrollTarget(end.isIntersecting ? void 0 : end.target),
        { root: import_global.default.window.document.querySelector("#panel-tab-content") }
      );
      if (endRef.current)
        observer.observe(endRef.current);
    }
    return () => observer == null ? void 0 : observer.disconnect();
  }, []);
  const emit = (0, import_api.useChannel)(
    {
      [import_instrumenter6.EVENTS.CALL]: setCall,
      [import_instrumenter6.EVENTS.SYNC]: (payload) => {
        setControlStates(payload.controlStates);
        setPausedAt(payload.pausedAt);
        setInteractions(
          getInteractions({ log: payload.logItems, calls: calls.current, collapsed, setCollapsed })
        );
        log.current = payload.logItems;
      },
      [import_core_events.STORY_RENDER_PHASE_CHANGED]: (event) => {
        setStoryId(event.storyId);
        setPlaying(event.newPhase === "playing");
        setPausedAt(void 0);
        if (event.newPhase === "rendering") {
          setErrored(false);
          setCaughtException(void 0);
        }
      },
      [import_core_events.STORY_THREW_EXCEPTION]: () => {
        setErrored(true);
      },
      [import_core_events.PLAY_FUNCTION_THREW_EXCEPTION]: (e) => {
        if ((e == null ? void 0 : e.message) !== import_core_events.IGNORED_EXCEPTION.message)
          setCaughtException(e);
        else
          setCaughtException(void 0);
      }
    },
    [collapsed]
  );
  React8.useEffect(() => {
    setInteractions(
      getInteractions({ log: log.current, calls: calls.current, collapsed, setCollapsed })
    );
  }, [collapsed]);
  React8.useEffect(() => {
    if (isPlaying || isRerunAnimating)
      return;
    setInteractionsCount(interactions.filter(({ method }) => method !== "step").length);
  }, [interactions, isPlaying, isRerunAnimating]);
  const controls = React8.useMemo(
    () => ({
      start: () => emit(import_instrumenter6.EVENTS.START, { storyId }),
      back: () => emit(import_instrumenter6.EVENTS.BACK, { storyId }),
      goto: (callId) => emit(import_instrumenter6.EVENTS.GOTO, { storyId, callId }),
      next: () => emit(import_instrumenter6.EVENTS.NEXT, { storyId }),
      end: () => emit(import_instrumenter6.EVENTS.END, { storyId }),
      rerun: () => {
        setIsRerunAnimating(true);
        emit(import_core_events.FORCE_REMOUNT, { storyId });
      }
    }),
    [storyId]
  );
  const storyFilePath = (0, import_api.useParameter)("fileName", "");
  const [fileName] = storyFilePath.toString().split("/").slice(-1);
  const scrollToTarget = () => scrollTarget == null ? void 0 : scrollTarget.scrollIntoView({ behavior: "smooth", block: "end" });
  const showStatus = interactionsCount > 0 || !!caughtException || isRerunAnimating;
  const hasException = !!caughtException || interactions.some((v) => v.status === import_instrumenter6.CallStates.ERROR);
  if (isErrored) {
    return /* @__PURE__ */ React8.createElement(React8.Fragment, {
      key: "interactions"
    });
  }
  return /* @__PURE__ */ React8.createElement(React8.Fragment, {
    key: "interactions"
  }, /* @__PURE__ */ React8.createElement(TabStatus, null, showStatus && (hasException ? /* @__PURE__ */ React8.createElement(TabIcon, {
    status: import_instrumenter6.CallStates.ERROR
  }) : ` (${interactionsCount})`)), /* @__PURE__ */ React8.createElement(InteractionsPanel, {
    calls: calls.current,
    controls,
    controlStates,
    interactions,
    fileName,
    hasException,
    caughtException,
    isPlaying,
    pausedAt,
    endRef,
    onScrollToEnd: scrollTarget && scrollToTarget,
    isRerunAnimating,
    setIsRerunAnimating,
    ...props
  }));
};

// src/manager.tsx
import_addons.addons.register(ADDON_ID, () => {
  import_addons.addons.add(PANEL_ID, {
    type: import_addons.types.PANEL,
    title: "Interactions",
    match: ({ viewMode }) => viewMode === "story",
    render: Panel
  });
});
